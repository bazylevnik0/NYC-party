<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>My first three.js app</title>
    <style>
      body {
        margin: 0;
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@v0.149.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@v0.149.0/examples/jsm/"
        }
      }
    </script>
  </head>
  <body>
    <button id="exit">EXIT</button>
  </body>
  <script type="module">
    import * as THREE from "three";

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );

    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setAnimationLoop(animate);
    document.body.appendChild(renderer.domElement);

    var guests = {};
    guests.geometries = [];
    guests.materials = [];
    guests.cubes = [];
    guests.data = [];
    guests.get_data = async function () {
      const url = location.protocol + "//" + location.host + "/data";
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Response status: ${response.status}`);
        }
        guests.data = await response.json();
        guests.build();
        console.log("guests.data: ", guests.data);
      } catch (error) {
        console.error(error.message);
      }
    };
    guests.get_data();

    guests.build = function () {
      guests.geometries = [];
      guests.materials = [];
      for (let i = 0; i < guests.cubes; i++) {
        scene.remove(guests.cubes[i]);
      }
      for (let i = 0; i < guests.data.length; i++) {
        guests.geometries[i] = new THREE.BoxGeometry(1, 1, 1);
        switch (guests.data[i].avatar) {
          case "human":
            guests.materials[i] = new THREE.MeshBasicMaterial({
              color: 0xff0000,
            });
            break;
          case "robot":
            guests.materials[i] = new THREE.MeshBasicMaterial({
              color: 0x00ff00,
            });
            break;
          case "sceleton":
            guests.materials[i] = new THREE.MeshBasicMaterial({
              color: 0x0000ff,
            });
            break;
          case "zombie":
            guests.materials[i] = new THREE.MeshBasicMaterial({
              color: 0xffff00,
            });
            break;
          case "ghost":
            guests.materials[i] = new THREE.MeshBasicMaterial({
              color: 0xff00ff,
            });
            break;
        }
        guests.cubes[i] = new THREE.Mesh(
          guests.geometries[i],
          guests.materials[i]
        );
        guests.cubes[i].position.x = i * 2;
        scene.add(guests.cubes[i]);
      }
    };
    guests.data_check = async function () {
      const url = location.protocol + "//" + location.host + "/data";
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Response status: ${response.status}`);
        }
        guests.data = await response.json();
        if (JSON.stringify(guests.data_old) === JSON.stringify(guests.data)) {
          return false;
        } else {
          guests.data_old = guests.data;
          return true;
        }
      } catch (error) {
        console.error(error.message);
      }
    };
    let check = guests.data_check();
    guests.data_interval = setInterval(() => {
      check = guests.data_check();
      if (check) guests.build();
    }, 1000);

    camera.position.z = 5;

    function animate() {
      renderer.render(scene, camera);
    }

    let params = new URLSearchParams(window.location.search);
    let nickname = params.get("nickname");
    let avatar = params.get("avatar");
    console.log(nickname, avatar);

    let button_exit = document.getElementById("exit");
    button_exit.addEventListener("click", () => {
      window.location =
        location.protocol + "//" + location.host + "/exit?nickname=" + nickname;
    });
  </script>
</html>
